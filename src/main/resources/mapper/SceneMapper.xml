<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tpadsz.after.dao.SceneDao">


    <select id="searchSceneList" resultType="com.tpadsz.after.entity.SceneList">
        SELECT s.id,s.sname AS sceneName,s.scene_id AS sceneId,#{lid} AS lid,#{meshName} AS meshName,#{meshId} AS meshId FROM f_scene s WHERE s.sname LIKE CONCAT('%',IFNULL(#{sceneName},''),'%') and s.scene_id LIKE CONCAT('%',IFNULL(#{sceneId},''),'%') and s.mid=#{mid} ORDER BY s.scene_id
    </select>

    <select id="findPlaceBySid" resultType="com.tpadsz.after.entity.MeshInfo">
        SELECT id AS pid,pname FROM f_place WHERE mid = (SELECT mid FROM f_scene WHERE id=#{sid}) ORDER BY place_id
    </select>

    <select id="findGroupByPid" resultType="com.tpadsz.after.entity.MeshInfo">
        SELECT id AS gid,gname FROM f_group WHERE pid = #{pid} ORDER BY group_id
    </select>

    <select id="findLightByGid" resultType="com.tpadsz.after.entity.MeshInfo">
        SELECT t1.id,t1.lmac,t1.lname,t2.x,t2.y FROM f_light AS t1 INNER JOIN f_light_setting AS t2 ON t1.id = t2.lid WHERE t1.gid = #{gid} and t2.sid = #{sid} ORDER BY t1.create_date
    </select>

    <select id="findLightInfoByLid" resultType="com.tpadsz.after.entity.MeshInfo">
        SELECT t1.id,t1.pid,t1.gid FROM f_light AS t1 WHERE t1.id = #{lid}
    </select>

    <select id="findXYBySid" resultType="com.tpadsz.after.entity.MeshInfo">
        SELECT DISTINCT(x),y FROM f_light_setting WHERE sid = #{sid}
    </select>

    <select id="findXYByGid" resultType="com.tpadsz.after.entity.MeshInfo">
        SELECT DISTINCT(t2.x),t2.y FROM f_light AS t1 INNER JOIN f_light_setting AS t2 ON t1.id = t2.lid WHERE t1.gid = #{gid} and t2.sid = #{sid}
    </select>

    <select id="findRepeatNameBySid" resultType="int">
        SELECT count(1) from f_scene s where s.sname = #{sceneName} and s.mid=(SELECT mid FROM f_scene WHERE id=#{sid})
    </select>

    <update id="renameScene">
        update f_scene s set s.sname = #{sceneName},s.update_date = NOW() where s.id=#{sid}
    </update>

    <delete id="delete" parameterType="int">
        DELETE FROM f_scene WHERE id = #{sid}
    </delete>

    <update id="saveSceneName">
        UPDATE f_scene SET sname = #{sceneName},update_date=NOW() WHERE id =#{sid}
    </update>

    <select id="findProjectByMeshId" resultType="com.tpadsz.after.entity.MeshInfo">
        SELECT t1.id AS project_id,t1.name,t2.id AS mid FROM f_project AS t1 INNER JOIN f_mesh AS t2 ON t1.id = t2.project_id WHERE t2.mesh_id = #{meshId}
    </select>

</mapper>