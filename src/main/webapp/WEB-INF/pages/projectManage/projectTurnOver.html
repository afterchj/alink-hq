<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/alink-hq/static/css/loding.css"/>
    <link rel="stylesheet" th:href="@{/static/css/base.css}">
    <link rel="stylesheet" th:href="@{/static/css/leftNav.css}">
    <link rel="stylesheet" th:href="@{/static/css/mesh.css}">
    <title>移交账号</title>
</head>

<body>
<input type="hidden" th:value="${projectInfo}" id="projectInfo">

<div class="c-container">
    <div th:replace="common/head::head"></div>
    <div class="main clearfix">
        <div th:replace="common/left::left('projectList')"></div>
        <div class="main-right f-l">
            <div class="clearfix main-right-nav">
                <div class="f-l main-right-title">项目移交</div>
                <div class="f-r pointer">
                    <!--<img src="/alink-hq/static/img/go-back.png" alt="" onclick="history.back()">-->
                    <div class="goBack" onClick="javascript :history.back(-1);" onmousedown="backBtnMouseDown()"
                         onmouseup="backBtnMouseUp()">
                        <span><</span><span>返回</span>
                    </div>
                </div>
            </div>
            <form class="" method="post">
                <div id="meshTurnOver">
                    <div class="f-nav">
                        项目移交
                    </div>
                    <div class="f-content scrollbar">
                        <div class="accountMsg clearfix" th:each="projectList:${projectList}">
                            <div class="f-l mesh-name">
                                <span th:text="${projectList.name}"></span>
                            </div>
                            <div class="f-l  mesh-id">
                                <label for="account">施工负责人：</label>
                                <input type="text" id="account" th:value="${projectList.account}" class="overflow"
                                       th:title="${projectList.account}" readonly/>
                            </div>
                            <div class="f-l mesh-project">
                                <label for="coname">隶属公司：</label>
                                <input type="text" id="coname" th:value="${projectList.coname}" class="overflow"
                                       th:title="${projectList.coname}" readonly/>
                            </div>
                        </div>
                    </div>
                    <div class="" style="text-align: center;margin-bottom: 30px;">
                        <img src="/alink-hq/static/img/exchange-un.png" alt="">
                    </div>
                    <div class="transfer-company p-r">
                        <p class="company-hint"></p>
                        <div style="margin-bottom: 30px;">
                            <label for="fid"><span>*</span>隶属公司：</label>
                            <select name="fid" id="fid" class="pointer overflow">
                                <option value="" class="pointer overflow">请选择公司</option>
                                <option th:each="firm:${firmList}" th:value="${firm.id}" th:text="${firm.coname }"
                                        class="pointer overflow"></option>
                            </select>
                        </div>
                        <p class="account-hint"></p>
                        <label for="account-transfer"><span>*</span>选择移交账号：</label>
                        <input type="text" id="account-transfer" placeholder="请选择账号" uid="" autocomplete="off"
                               class="overflow">
                        <span class="open-list"></span>
                        <div id="list" class="overflow">
                            <ul>
                            </ul>
                        </div>
                    </div>

                    <div class="tranfer-btn">
                        <button class="confirm-btn" type="button">确定移交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="hide-iframe"></div>
<div id="preload-anim">
    <div id="circularG">
        <div id="circularG_1" class="circularG"></div>
        <div id="circularG_2" class="circularG"></div>
        <div id="circularG_3" class="circularG"></div>
        <div id="circularG_4" class="circularG"></div>
        <div id="circularG_5" class="circularG"></div>
        <div id="circularG_6" class="circularG"></div>
        <div id="circularG_7" class="circularG"></div>
        <div id="circularG_8" class="circularG"></div>
    </div>
    <p class="title">
    </p>
</div>

<script src="/alink-hq/static/js/jquery.min.js"></script>
<script  src="/alink-hq/static/js/left.js"></script>
<script src="/alink-hq/static/js/moment.js"></script>

<script>
    $(function () {
        var list = [];
        $('#fid').change(function () {
            $('#account-transfer').val('');
            var fid = $(this).children('option:selected').val();
            if (fid != '') {
                fid = parseInt(fid);
            }
            $('#list ul').children().remove();
            $.ajax({
                type: "post",
                url: "/alink-hq/project/findAccountByFid",
                data: {fid: fid},
                dataType: "json",
                success: function (data) {
                    console.log(data.accounts);
                    var content = '';
                    for (var i = 0; i < data.accounts.length; i++) {
                        var uid = data.accounts[i].id;
                        var accountName = data.accounts[i].account;
                        content += '<li value="' + uid + '">' + accountName + '</li>';
                    }
                    $('#list ul').append(content);
                    list = data.accounts;
                    console.log('list', list);
                }
            })
        })
        $("#list ul").on("click", 'li', function () {
            console.log($(this).text());
            $('#account-transfer').val($(this).text());
            $('#account-transfer').attr('uid', $(this).attr('value'))
            $('#list').removeClass('active');
        });
        $('.open-list').click(function () {
            $('#list').toggleClass('active');
        })
        $('#account-transfer').click(function () {
            $('#list').addClass('active');
            if ($('#list ul').height() == 0) {
                $('#list').removeClass('active');
            }
        })
        $('#account-transfer').bind('input propertychange', function () {

            var keyword = $(this).val();
            if (keyword != '') {
                $('.account-hint').text('');
            } else {
                $('.account-hint').text('请选择账号');
            }
            var keyArr = [];


            var reg = new RegExp(keyword);

            for (var i = 0; i < list.length; i++) {
                if (list[i].account != null && list[i].account.match(reg)) {

                    var msg = {
                        uid: list[i].uid,
                        account: list[i].account
                    }
                    keyArr.push(msg);

                }
            }

            var content = '';
            for (var i = 0; i < keyArr.length; i++) {
                content += '<li value="' + keyArr[i].uid + '">' + keyArr[i].account + '</li>';
            }

            $('#list ul').children().remove();
            $('#list ul').append(content);
            if (keyArr.length == 0) {
                $('#list').removeClass('active');
            }
        });
        $('.confirm-btn').click(function () {
            var projectInfo = $('#projectInfo').val();
            var fid = $('#fid option:selected').val();
            var uid = $('#account-transfer').attr('uid');
            var account = $('#account-transfer').val();
            var hasAccount = true;
            for (var i = 0; i < list.length; i++) {
                if (list[i].account != null && list[i].account == account) {
                    uid = list[i].id;
                    hasAccount = true;
                    console.log('找到了', uid, list[i].account);
                    break;
                } else {

                    hasAccount = false;
                }
            }
            if (uid == '') {
                $('.account-hint').text('请选择账号');
            } else {
                $('.account-hint').text('');
            }
            if (fid == '') {
                $('.company-hint').text('请选择公司')
            } else {
                $('.company-hint').text('');
            }

            if (fid != '' && uid != '' && hasAccount) {
                $.ajax({
                    type: "post",
                    url: "/alink-hq/project/transfer",
                    data: {projectInfo: projectInfo, uid: uid},
                    dataType: "json",
                    success: function (data) {
                        console.log(data);
                        if (data.result == '000') {
                            $('#preload-anim').addClass('active');
                            $('.hide-iframe').addClass('active');
                            $('#preload-anim .title').text('移交成功，正在跳转项目列表');
                            setInterval(function () {
                                window.location.href = '/alink-hq/project/list';
                            }, 1000)
                        }
                    }
                })
            }
        })
    })
    //监听公司选择
    $('#fid').change(function () {
        var selected = $(this).children('option:selected').val();
        if (selected == '') {
            $('.company-hint').text('请选择公司');
        } else {
            $('.company-hint').text('');
        }
    })
</script>
</body>
</html>