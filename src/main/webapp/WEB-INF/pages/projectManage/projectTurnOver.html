<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" th:href="@{/static/font-awesome-4.7.0/css/font-awesome.min.css}"/>
    <link rel="stylesheet"  th:href="@{/static/css/loding.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/base.css}">
    <link rel="stylesheet" th:href="@{/static/css/leftNav.css}">
    <link rel="stylesheet" th:href="@{/static/css/projectManage.css}">
    <title>项目移交</title>
</head>

<body>
<input type="hidden" th:value="${ids}" id="ids">

<div class="c-container">
    <div th:replace="common/head::head"></div>
    <div class="main clearfix">
        <div th:replace="common/left::left('projectList')"></div>
        <div class="main-right f-l">
            <div class="clearfix main-right-nav">
                <div class="f-l main-right-title">
                    <nav class="bread">
                        <ol class="clearfix">
                            <li class="f-l"><a th:href="@{/project/list}">项目列表</a></li>
                            <li class="f-l">项目移交</li>
                        </ol>
                    </nav>
                </div>
                <div class="f-r pointer">
                    <!--<img src="/alink-hq/static/img/go-back.png" alt="" onclick="history.back()">-->
                    <div class="goBack" onClick="javascript :history.back(-1);" onmousedown="backBtnMouseDown()"
                         onmouseup="backBtnMouseUp()">
                        <span><</span><span>返回</span>
                    </div>
                </div>
            </div>
            <div class="table-content-list detail transfer">
                <form class="" method="post">
                    <div id="meshTurnOver" class="p-detail">
                        <div class="f-nav p-nav">
                            项目移交
                        </div>
                        <div class="p-content p-r">
                            <div class="f-content scrollbar ">
                                <div class="accountMsg clearfix" th:each="project:${projectMap}">
                                    <div class="f-l mesh-name overflow-hidden-1">
                                        <span th:text="${project.name}" th:title="${project.name}"></span>
                                    </div>
                                    <div class="f-l  mesh-id">
                                        <label >施工负责人：</label>
                                        <input type="text" id="account" th:value="${project.account}"
                                               class="overflow"
                                               th:title="${project.account}" readonly/>
                                    </div>
                                    <div class="f-l mesh-project">
                                        <label >隶属公司：</label>
                                        <input type="text" id="coname" th:value="${project.coname}" class="overflow"
                                               th:title="${project.coname}" readonly/>
                                    </div>
                                </div>
                            </div>
                            <div class="" style="text-align: center;margin: 40px 0 18px 0;">
                                <img src="/alink-hq/static/img/exchange-un.png" alt="">
                            </div>

                            <fieldset>
                                <div class="transfer-company p-r clearfix">
                                    <div class="form-row">
                                        <div class="field-label" style="width: 135px;">
                                            <label ><span>*</span>隶属公司：</label>
                                        </div>
                                        <div class="field-widget p-r" >
                                            <p class="p-a verify "></p>
                                            <select name="fid" id="fid" class="pointer overflow">
                                                <option value="" class="pointer overflow">请选择公司</option>
                                                <option th:each="firm:${firmList}" th:value="${firm.id}"
                                                        th:text="${firm.coname }"
                                                        class="pointer overflow"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="field-label" style="width: 135px;">
                                            <label ><span>*</span>选择移交账号：</label>
                                        </div>
                                        <div class="field-widget p-r">
                                            <p class=" p-a verify "></p>
                                            <input type="text" id="account-transfer" placeholder="请选择账号" uid=""
                                                   autocomplete="off"
                                                   class="overflow">
                                            <i class="fa fa-caret-down open-list" aria-hidden="true"></i>
                                            <!--<span class="open-list"></span>-->
                                            <div id="list" class="overflow">
                                                <ul>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tranfer-btn ">
                                    <button class="confirm-btn" type="button">确定移交</button>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="hide-iframe"></div>
<div id="preload-anim">
    <div id="circularG">
        <div id="circularG_1" class="circularG"></div>
        <div id="circularG_2" class="circularG"></div>
        <div id="circularG_3" class="circularG"></div>
        <div id="circularG_4" class="circularG"></div>
        <div id="circularG_5" class="circularG"></div>
        <div id="circularG_6" class="circularG"></div>
        <div id="circularG_7" class="circularG"></div>
        <div id="circularG_8" class="circularG"></div>
    </div>
    <p class="title">
    </p>
</div>

<script src="/alink-hq/static/js/jquery.min.js"></script>
<script src="/alink-hq/static/js/left.js"></script>
<script src="/alink-hq/static/js/moment.js"></script>

<script>
    $(function () {
        var list = [];
        $('#fid').change(function () {
            $('#account-transfer').val('');
            var fid = $(this).children('option:selected').val();
            if (fid != '') {
                fid = parseInt(fid);
            }
            $('#list ul').children().remove();
            $.ajax({
                type: "post",
                url: "/alink-hq/project/findAccountByFid",
                data: {fid: fid},
                dataType: "json",
                success: function (data) {
                    console.log(data.accounts);
                    var content = '';
                    for (var i = 0; i < data.accounts.length; i++) {
                        var uid = data.accounts[i].id;
                        var accountName = data.accounts[i].account;
                        content += '<li value="' + uid + '">' + accountName + '</li>';
                    }
                    $('#list ul').append(content);
                    list = data.accounts;
                    console.log('list', list);
                }
            })
        })
        $("#list ul").on("click", 'li', function () {
            console.log($(this).text());
            $('#list').hide();
            $('#account-transfer').val($(this).text());
            $('#account-transfer').attr('uid', $(this).attr('value'))
//            $('#list').removeClass('active');
        });
        $('#list').hide();
        $('.open-list').click(function () {
            $('#list').toggle();
        })
//        $('#account-transfer').click(function () {
//            $('#list').addClass('active');
//            if ($('#list ul').height() == 0) {
//                $('#list').removeClass('active');
//            }
//        })
        $('#account-transfer').bind('input propertychange', function () {

            var keyword = $(this).val();
            if (keyword != '') {
                $(this).prev('.verify').text('');
            } else {
                $(this).prev('.verify').text('请选择账号');
//                $('.account-hint').text('请选择账号');
            }
            var keyArr = [];


            var reg = new RegExp(keyword);

            for (var i = 0; i < list.length; i++) {
                if (list[i].account != null && list[i].account.match(reg)) {

                    var msg = {
                        uid: list[i].uid,
                        account: list[i].account
                    }
                    keyArr.push(msg);

                }
            }

            var content = '';
            for (var i = 0; i < keyArr.length; i++) {
                content += '<li value="' + keyArr[i].uid + '">' + keyArr[i].account + '</li>';
            }

            $('#list ul').children().remove();
            $('#list ul').append(content);
            if (keyArr.length == 0) {
                $('#list').removeClass('active');
            }
        });
        $('.confirm-btn').click(function () {
            var ids = $('#ids').val();
            var fid = $('#fid option:selected').val();
            var uid = $('#account-transfer').attr('uid');
            var account = $('#account-transfer').val();
            var hasAccount = true;
            for (var i = 0; i < list.length; i++) {
                if (list[i].account != null && list[i].account == account) {
                    uid = list[i].id;
                    hasAccount = true;
                    console.log('找到了', uid, list[i].account);
                    break;
                } else {
                    hasAccount = false;
                }
            }
            if (uid == '') {
                $('#account-transfer').prev('.verify').text('请选择账号');
            } else {
                $('#account-transfer').prev('.verify').text('');
            }
            if (fid == '') {
                $('#fid').prev('.verify').text('请选择公司')
            } else {
                $('#fid').prev('.verify').text('');
            }

            if (fid != '' && uid != '' && hasAccount) {
                $.ajax({
                    type: "post",
                    url: "/alink-hq/project/transfer",
                    data: {idss: ids, uid: uid},
                    dataType: "json",
                    success: function (data) {
//                        console.log(data);
                        if (data.result == '000') {
                            $('#preload-anim').addClass('active');
//                            $('.hide-iframe').addClass('active');
                            $('#preload-anim .title').text('移交成功，正在跳转项目列表');
                            setTimeout(function () {
                                window.location.href = '/alink-hq/project/list';
                            }, 500)
                        }
                    }
                })
            }
        })
    })
    //监听公司选择
    $('#fid').change(function () {
        var selected = $(this).children('option:selected').val();
        if (selected == '') {
            $(this).prev('.verify').text('请选择公司');
        } else {
            $(this).prev('.verify').text('');
        }
    })
</script>
</body>
</html>