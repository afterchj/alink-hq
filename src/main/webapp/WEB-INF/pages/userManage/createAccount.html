<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/alink-hq/static/css/loding.css"/>
    <link rel="stylesheet" href="/alink-hq/static/css/base.css"/>
    <link rel="stylesheet" href="/alink-hq/static/css/leftNav.css"/>
    <link rel="stylesheet" href="/alink-hq/static/css/userManage.css"/>
    <title>创建账号</title>
</head>

<body>

<div class="c-container">
    <div th:replace="common/head::head"></div>
    <div class="main clearfix">
        <div th:replace="common/left::left('createAccount')"></div>

        <div class="main-right f-r">
            <div class="clearfix main-right-nav">
                <div class="f-l main-right-title">创建账号</div>
                <div class="f-r pointer">
                    <div class="goBack" onClick="javascript :history.back(-1);">
                        <span><</span><span>返回</span>
                    </div>
                    <!--<img src="/alink-hq/static/img/go-back.png" onClick="javascript :history.back(-1);" alt=""/>-->
                </div>
            </div>
            <div id="createAccount">
                <div class="c-createAccount">
                    <div class="c-nav">
                        新建账号
                    </div>
                    <div class="c-content ">
                        <form>
                            <p class="create-company-hint"></p>
                            <div>

                                <label for="fid">隶属公司：</label>
                                <select name="fid" id="fid" class="pointer">
                                    <option value="">请选择公司</option>
                                    <option th:each="firm:${firmList}" name="fid" th:value="${firm.id}"
                                            th:text="${firm.coname}"></option>
                                </select>
                            </div>
                            <div class="role-radio">
                                <label for="">角色：</label>
                                <label shiro:hasAnyRoles="super" for="" class="l-radio">
                                    <img src="/alink-hq/static/img/select-un.png" alt=""/>
                                    <input type="radio" value="2"/>管理员
                                </label>
                                <label shiro:hasAnyRoles="super,admin" for="" class="l-radio">
                                    <img src="/alink-hq/static/img/select-un.png" alt=""/>
                                    <input type="radio" value="3"/>乙方管理员
                                </label>
                                <label shiro:hasAnyRoles="super,admin,manager" for="" class="l-radio">
                                    <img src="/alink-hq/static/img/select-on.png" alt=""/>
                                    <input type="radio" value="4"/>施工人员
                                </label>
                            </div>
                            <p class="create-num-hint"></p>
                            <div>
                                <label for="">创建账号数量：</label>
                        <span class="num clearfix">
                            <div class="f-l reduce-num pointer">-</div>
                            <input type="text" name="num" value="1" class="create-num">
                            <div class="f-r add-num pointer">+</div>
                        </span>
                                <span class="create-account-hint">最多一次可添加100个账号</span>
                            </div>
                            <div class="">
                                <button type="button" class="confirm-create" openTab="confirm-create">确定创建</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 确定到处弹框 -->
<div class="confirm-create-iframe  pop-iframe " openContent="confirm-create">
    <div class="create-nav p-r pop-nav">
        导出账号
        <img src="/alink-hq/static/img/close.png" alt="" class="p-a pointer close">
    </div>
    <div class="create-content pop-content">
        <div class="c-main">
            <div class="c-title ">
                <div class="clearfix">
                    <div class="f-l c-width one">账号</div>
                    <div class="f-l c-width two">密码</div>
                </div>

            </div>
            <div class="c-list clearfix">
            </div>
        </div>
        <a href="#" onclick="method5('d2')">Excel导出</a>
        <!--<a href="#" id="excel">Excel导出</a>-->
        <p class="c-hint">注：请牢记/导出新账号密码，关闭后将无法展示。</p>
        <table id="d2" style="display:none;margin-left: 30px;">
            <thead>
            <tr>
                <td>账号</td>
                <td>密码</td>
            </tr>
            </thead>
            <tbody id="toExcel">
            </tbody>

        </table>
    </div>
</div>
<div class="hide-iframe active"></div>
<div id="preload-anim">
    <div id="circularG">
        <div id="circularG_1" class="circularG"></div>
        <div id="circularG_2" class="circularG"></div>
        <div id="circularG_3" class="circularG"></div>
        <div id="circularG_4" class="circularG"></div>
        <div id="circularG_5" class="circularG"></div>
        <div id="circularG_6" class="circularG"></div>
        <div id="circularG_7" class="circularG"></div>
        <div id="circularG_8" class="circularG"></div>
    </div>
    <p class="title">

    </p>
</div>
<script src="/alink-hq/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/alink-hq/static/js/left.js"></script>
<script type="text/javascript" src="/alink-hq/static/js/excel/excel.js"></script>
<script  src="/alink-hq/static/js/selectivizr.js"></script>
<script  src="/alink-hq/static/js/html5shiv.js"></script>

<script>
    var list = [];
    $('button.confirm-create').click(function () {
        var fid = $('#fid option:selected').val();
        if (fid == '') {
            $('p.create-company-hint').text('请选择公司');
        } else {
            fid = parseInt(fid);
            $('p.create-company-hint').text();
        }
        var roleId;
        $('.role-radio .l-radio').each(function () {
            var imgUrl = $(this).find('img').attr('src');
            console.log(imgUrl);
            if (imgUrl == '/alink-hq/static/img/select-on.png') {
                roleId = parseInt($(this).find('input').val());
            }
        })
        var num = $('.create-num').val();
        if (num != '') {
            num = parseInt(num);
        }
        console.log(fid, roleId, num);
        if (fid != '' && roleId != '') {
            this.setAttribute("disabled", true);
            this.style.background = "#A0A0A0";
            this.style.borderColor = "#A0A0A0";
            $.ajax({
                type: "POST",
                url: "/alink-hq/account/create",
                data: {fid: fid, roleId: roleId, num: num},
                dataType: "json",
                success: function (res) {
                    if (res.result == '000') {
                        $('.pop-iframe').addClass('active');
                        var width = document.body.scrollWidth;
                        var height = document.body.scrollHeight;
                        $('.hide-iframe').addClass('active');
                        $('.hide-iframe').css({
                            'width': width,
                            'height': height
                        });
                        var accountList = JSON.parse(res.accountList);
                        var maxLength = accountList.length;
                        if (maxLength > 3) {
                            $('.c-title .c-width.two').css('width', ' 163px');
                            $('.confirm-create-iframe .c-main').css('width', '310px');
                        }
                        var arr = {};
                        for (var i = 0; i < accountList.length; i++) {
                            var account = accountList[i];
                            var pwd = '00000000';
                            arr.account = account;
                            arr.pwd = pwd;
                            list.push(arr);
                            arr = {};
                            var content = '<div class="clearfix"><div class="f-l c-width one">' + account + '</div>'
                                    + '<div class="f-l c-width two">' + pwd + '</div></div>';
                            $('.c-list').append(content);
                        }
                        toExcel(list);
                    } else {
                        $('#preload-anim').addClass('active');
                        $('#preload-anim .title').text('加载失败，请重新尝试');
                        setInterval(function () {
                            $('#preload-anim').removeClass('active');
                        }, 1000)
                    }
                }
            })
        }

    })
    $('.pop-nav .close').click(function () {
        $('.pop-iframe').removeClass('active');
        $('.hide-iframe').removeClass('active');
        $('#preload-anim').addClass('active');
        $('#preload-anim .title').text(' 创建成功，正在跳转用户列表');
        setInterval(function () {
            window.location.href = '/alink-hq/account/list';
        }, 1000)
    })

    $('#createAccount .c-content img').click(function () {
        var imgUrl = $(this).attr('src');
        var isRadio = '/alink-hq/static/img/select-on.png';
        var noRadio = '/alink-hq/static/img/select-un.png';
        if (imgUrl == noRadio) {
            $(this).attr('src', isRadio);
            $(this).parent('label').siblings().find('img').attr('src', noRadio);
        }
    })
    $(function () {
        var num = 1;
        $('.add-num').click(function () {
            num = $('.create-num').val();
            if (num != '') {
                num = parseInt(num);
            } else {
                num = 1;
            }
            if (num < 100) {
                num++;
                $('.create-num').val(num);
            }
        })
        $('.reduce-num').click(function () {
            num = $('.create-num').val();
            console.log(num);
            if (num > 1) {
                num--;
                $('.create-num').val(num);
            }

        })
    })
    //监听公司选择
    $('#fid').change(function () {
        var selected = $(this).children('option:selected').val();
        if (selected == '') {
            $('p.create-company-hint').text('请选择公司');
        } else {
            $('p.create-company-hint').text('');
        }
    })

    $(".create-num").bind('input propertychange', function () {
        var num = $(this).val();
        if (num == '') {
            $('p.create-num-hint').text('');
        } else {
            num = parseInt(num);
            if (isNaN(num)) {
                $('.create-num').val('');
            } else {
                if (num > 100) {
                    $('.create-num').val('100');
                    $('p.create-num-hint').text('一次最多创建100个账号');
                } else if (num < 1) {
                    $('.create-num').val('1');
                    $('p.create-num-hint').text('不能再少了');
                } else {
                    $('p.create-num-hint').text('');
                }
            }
        }
    })
</script>
</body>

</html>